rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================

    // Checks if the requesting user is an authenticated admin.
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Checks if the requesting user owns a specific membership document.
    function isAthleteOwner(membershipId) {
      return request.auth != null && request.auth.uid == get(/databases/$(database)/documents/memberships/$(membershipId)).data.uid;
    }

    // Checks if the requesting user is the coach assigned to a specific application.
    function isCoachForApplication(applicationId) {
        let application = get(/databases/$(database)/documents/coachingApplications/$(applicationId)).data;
        let coachMembership = get(/databases/$(database)/documents/memberships/$(request.auth.uid)).data;
        return request.auth != null && application.coachName == coachMembership.customerName;
    }
    
    // Checks if the requesting user is the coach for a specific client membership.
    function isCoachForClient(membershipId) {
        let clientMembership = get(/databases/$(database)/documents/memberships/$(membershipId)).data;
        let coachMembership = get(/databases/$(database)/documents/memberships/$(request.auth.uid)).data;
        return request.auth != null && clientMembership.coachName == coachMembership.customerName;
    }


    // =================================
    // Admin Rules
    // =================================
    
    // Admins have full access to all data for dashboard and management purposes.
    match /{path=**} {
      allow read, write: if isAdmin();
    }


    // =================================
    // Public & Client Rules
    // =================================

    // Allow public read access to collections needed for the storefront.
    match /(products|coaches|settings|shippingOptions)/{docId} {
      allow read: if true;
    }

    // Allow anyone to create orders, contact submissions, and coaching applications.
    match /orders/{orderId} {
      allow create: if true;
    }
    match /contactSubmissions/{submissionId} {
      allow create: if true;
    }
    match /coachingApplications/{applicationId} {
        allow create: if true;
    }


    // =================================
    // Coach & Athlete Rules
    // =================================

    // Memberships can be read by their owner (athlete) or the assigned coach.
    match /memberships/{membershipId} {
      allow read: if isAthleteOwner(membershipId) || isCoachForClient(membershipId);
    }
    
    // Coaches can view their own applications and update their status.
    match /coachingApplications/{applicationId} {
        allow read, update: if isCoachForApplication(applicationId);
    }
  }
}